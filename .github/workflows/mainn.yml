name: Multiple Independent RDP Sessions

on:
  workflow_dispatch:
    inputs:
      session_count:
        description: 'Number of INDEPENDENT RDP sessions to create (max 20)'
        required: true
        default: '3'
        type: choice
        options:
        - '1'
        - '3'
        - '5'
        - '10'
        - '15'
        - '20'

jobs:
  multi-independent-rdp:
    runs-on: windows-latest
    timeout-minutes: 3600
    
    strategy:
      matrix:
        session: [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20]
      max-parallel: 2  # ŸÑŸÑÿ™ÿ≠ŸÉŸÖ ŸÅŸä ÿßŸÑÿ≠ŸÖŸÑ

    steps:
      - name: Check if session is needed
        id: check_session
        run: |
          $sessionNumber = ${{ matrix.session }}
          $requestedSessions = ${{ github.event.inputs.session_count }}
          if ($sessionNumber -gt $requestedSessions) {
            Write-Host "Session $sessionNumber skipped - only $requestedSessions requested"
            echo "SKIP_SESSION=true" >> $env:GITHUB_ENV
          } else {
            echo "SKIP_SESSION=false" >> $env:GITHUB_ENV
            echo "SESSION_NUMBER=$sessionNumber" >> $env:GITHUB_ENV
          }

      - name: Configure RDP for Session ${{ matrix.session }}
        if: env.SKIP_SESSION == 'false'
        run: |
          # Enable RDP
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' `
                           -Name "fDenyTSConnections" -Value 0 -Force
          
          # Configure unique port for this session (33890, 33891, etc)
          $rdpPort = 33890 + $env:SESSION_NUMBER
          Set-ItemProperty -Path "HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp" `
                           -Name "PortNumber" -Value $rdpPort -Force
          
          # Firewall rule for this specific port
          netsh advfirewall firewall delete rule name="RDP-Session$env:SESSION_NUMBER" -ErrorAction SilentlyContinue
          netsh advfirewall firewall add rule name="RDP-Session$env:SESSION_NUMBER" `
              dir=in action=allow protocol=TCP localport=$rdpPort
          
          # Restart service
          Restart-Service -Name TermService -Force
          
          echo "RDP_PORT=$rdpPort" >> $env:GITHUB_ENV

      - name: Create User for Session ${{ matrix.session }}
        if: env.SKIP_SESSION == 'false'
        run: |
          function New-SecurePassword {
              $charSet = @{
                  Upper   = [char[]](65..90)
                  Lower   = [char[]](97..122)
                  Number  = [char[]](48..57)
                  Special = ([char[]](33..47) + [char[]](58..64) + [char[]](91..96) + [char[]](123..126))
              }
              $rawPassword = @()
              $rawPassword += $charSet.Upper | Get-Random -Count 3
              $rawPassword += $charSet.Lower | Get-Random -Count 3
              $rawPassword += $charSet.Number | Get-Random -Count 3
              $rawPassword += $charSet.Special | Get-Random -Count 3
              return -join ($rawPassword | Sort-Object { Get-Random })
          }

          $username = "SessionUser$env:SESSION_NUMBER"
          $password = New-SecurePassword
          
          # Remove if exists and create new
          Remove-LocalUser -Name $username -ErrorAction SilentlyContinue
          $securePass = ConvertTo-SecureString $password -AsPlainText -Force
          New-LocalUser -Name $username -Password $securePass -AccountNeverExpires
          Add-LocalGroupMember -Group "Administrators" -Member $username
          Add-LocalGroupMember -Group "Remote Desktop Users" -Member $username
          
          echo "RDP_USERNAME=$username" >> $env:GITHUB_ENV
          echo "RDP_PASSWORD=$password" >> $env:GITHUB_ENV

      - name: Install Tailscale for Session ${{ matrix.session }}
        if: env.SKIP_SESSION == 'false'
        run: |
          $tsUrl = "https://pkgs.tailscale.com/stable/tailscale-setup-latest-amd64.msi"
          $installerPath = "$env:TEMP\tailscale-$env:SESSION_NUMBER.msi"
          
          Invoke-WebRequest -Uri $tsUrl -OutFile $installerPath
          Start-Process msiexec.exe -ArgumentList "/i", "`"$installerPath`"", "/quiet", "/norestart" -Wait
          Remove-Item $installerPath -Force

      - name: Establish Unique Tailscale Connection ${{ matrix.session }}
        if: env.SKIP_SESSION == 'false'
        run: |
          # Generate unique hostname for each session
          $hostname = "gh-rdp-session$env:SESSION_NUMBER-$env:GITHUB_RUN_ID"
          
          & "$env:ProgramFiles\Tailscale\tailscale.exe" up --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} --hostname=$hostname --accept-routes
          
          # Get unique Tailscale IP for this session
          $tsIP = $null
          $retries = 0
          while (-not $tsIP -and $retries -lt 15) {
              $tsIP = & "$env:ProgramFiles\Tailscale\tailscale.exe" ip -4
              Start-Sleep -Seconds 3
              $retries++
          }
          
          if (-not $tsIP) {
              Write-Error "Tailscale IP not assigned for session $env:SESSION_NUMBER"
              exit 1
          }
          
          echo "TAILSCALE_IP=$tsIP" >> $env:GITHUB_ENV
          Write-Host "Session $env:SESSION_NUMBER - Tailscale IP: $tsIP"

      - name: Verify RDP Connection ${{ matrix.session }}
        if: env.SKIP_SESSION == 'false'
        run: |
          $testResult = Test-NetConnection -ComputerName $env:TAILSCALE_IP -Port $env:RDP_PORT
          if ($testResult.TcpTestSucceeded) {
              Write-Host "‚úì Session $env:SESSION_NUMBER: RDP accessible at $env:TAILSCALE_IP:$env:RDP_PORT"
          } else {
              Write-Host "‚úó Session $env:SESSION_NUMBER: RDP connection failed"
              exit 1
          }

      - name: Display Session Info ${{ matrix.session }}
        if: env.SKIP_SESSION == 'false'
        run: |
          Write-Host "`n" + "="*60
          Write-Host "INDEPENDENT RDP SESSION $env:SESSION_NUMBER"
          Write-Host "="*60
          Write-Host "üåê Connection Address: $env:TAILSCALE_IP:$env:RDP_PORT"
          Write-Host "üë§ Username: $env:RDP_USERNAME"
          Write-Host "üîë Password: $env:RDP_PASSWORD"
          Write-Host "üÜî Session ID: $env:SESSION_NUMBER"
          Write-Host "‚è∞ Runner: $env:GITHUB_RUN_ID"
          Write-Host "="*60
          
          # Save session info to file for final summary
          $sessionInfo = @{
              SessionNumber = $env:SESSION_NUMBER
              TailscaleIP = $env:TAILSCALE_IP
              Port = $env:RDP_PORT
              Username = $env:RDP_USERNAME
              Password = $env:RDP_PASSWORD
          }
          $sessionInfo | ConvertTo-Json | Out-File -FilePath "$env:GITHUB_WORKSPACE\session$env:SESSION_NUMBER.json"

      - name: Maintain Session ${{ matrix.session }}
        if: env.SKIP_SESSION == 'false'
        run: |
          Write-Host "üîÑ Session $env:SESSION_NUMBER active - Monitoring connection..."
          $counter = 0
          while ($true) {
              $counter++
              # Test connection every minute
              $testResult = Test-NetConnection -ComputerName $env:TAILSCALE_IP -Port $env:RDP_PORT -ErrorAction SilentlyContinue
              $status = if ($testResult.TcpTestSucceeded) { "ACTIVE ‚úì" } else { "INACTIVE ‚úó" }
              
              Write-Host "[$(Get-Date)] Session $env:SESSION_NUMBER - Status: $status - Runtime: $($counter * 30) seconds"
              
              if ($counter -gt 120) { # Stop after 1 hour per session for demo
                  Write-Host "Session $env:SESSION_NUMBER completed demo period"
                  break
              }
              Start-Sleep -Seconds 30
          }

  final-summary:
    runs-on: windows-latest
    needs: multi-independent-rdp
    if: always()
    
    steps:
      - name: Display All Active Sessions
        run: |
          Write-Host "`n" + "="*70
          Write-Host "üéØ MULTIPLE INDEPENDENT RDP SESSIONS - SUMMARY"
          Write-Host "="*70
          Write-Host "Total Sessions Requested: ${{ github.event.inputs.session_count }}"
          Write-Host "All sessions are COMPLETELY INDEPENDENT with different Tailscale IPs"
          Write-Host "="*70
          Write-Host "‚úÖ All configured sessions are active and ready for use!"
          Write-Host "üìã Each session has unique credentials and connection details"
          Write-Host "üîó Use the individual session information above to connect"
          Write-Host "="*70
